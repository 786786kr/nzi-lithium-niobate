<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Photonic Crystal Visualization</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script> <!-- Load Plotly -->
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        select {
            padding: 10px;
            margin-bottom: 20px;
            font-size: 16px;
        }
        #plots-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .plot-container {
            width: 100%;
        }
        .plot-container div {
            width: 100%;
            height: 500px;
        }
    </style>
</head>
<body>

    <h1>Select Crystal Lattice and Geometry ID</h1>

    <!-- Dropdown menu to select an ID -->
    <select id="idDropdown" onchange="updatePlots()">
        <!-- Options will be populated dynamically -->
    </select>

    <!-- Container to display the epsilon, bands, and field plots -->
    <div id="plots-container">
        <div class="plot-container">
            <h3>Epsilon Plot</h3>
            <div id="epsilonPlot"></div> <!-- Plotly plot will be rendered here -->
        </div>
        <div class="plot-container">
            <h3>Bands Plot</h3>
            <div id="gapsPlot"></div> <!-- Plotly plot will be rendered here -->
        </div>
        <div class="plot-container">
            <h3>Field Plot</h3>
            <div id="fieldPlot"></div> <!-- Plotly plot will be rendered here -->
        </div>
    </div>

    <script>
    // Function to fetch IDs from the server
    async function fetchIds() {
        try {
            const response = await fetch('/pics');
            const files = await response.json();
            const ids = files
                .filter(file => file.endsWith('_bands.html'))
                .map(file => file.replace('_bands.html', ''));
            return ids;
        } catch (error) {
            console.error('Error fetching IDs:', error);
            return [];
        }
    }

    // Fetch IDs and populate the dropdown on page load
    window.onload = async function() {
        const ids = await fetchIds();
        ids.forEach(id => {
            const option = document.createElement('option');
            option.value = id;
            option.text = id;
            idDropdown.appendChild(option);
        });
    };

    // Get references to the dropdown and plot div elements
    const idDropdown = document.getElementById('idDropdown');
    const epsilonPlot = document.getElementById('epsilonPlot');
    const gapsPlot = document.getElementById('gapsPlot');
    const fieldPlot = document.getElementById('fieldPlot');

    // Function to update the plots when an ID is selected
    function updatePlots() {
        const selectedId = idDropdown.value;

        // Load epsilon plot and render it using Plotly
        fetch(`/pics/${selectedId}_epsilon.html`)
            .then(response => response.text())  // Fetch the HTML content as text
            .then(html => {
                const plotData = extractPlotData(html);
                Plotly.newPlot(epsilonPlot, plotData.data, plotData.layout);
            });

        // Load bands plot and render it using Plotly
        fetch(`/pics/${selectedId}_bands.html`)
            .then(response => response.text())  // Fetch the HTML content as text
            .then(html => {
                const plotData = extractPlotData(html);
                Plotly.newPlot(gapsPlot, plotData.data, plotData.layout);

                // Attach event listener after the plot is fully rendered
                gapsPlot.on('plotly_click', function(event) {
                    const clickedKPoint = event.points[0].customdata;  // Get the k-point from the clicked data
                    const kPointString = JSON.stringify(clickedKPoint);

                    // Fetch the field plot corresponding to the clicked k-point
                    fetch(`/plot_mode?k_point=${encodeURIComponent(kPointString)}&id=${selectedId}`)
                        .then(response => response.json())
                        .then(data => {
                            const fieldPlotData = extractPlotData(data.fieldHtml);
                            Plotly.newPlot(fieldPlot, fieldPlotData.data, fieldPlotData.layout);
                        })
                        .catch(error => console.error('Error fetching field plot:', error));
                });
            });
    }

    // Function to extract Plotly plot data from HTML content
    function extractPlotData(html) {
        const div = document.createElement('div');
        div.innerHTML = html;
        const script = div.querySelector('script[type="application/json"]');
        return JSON.parse(script.textContent);
    }
    </script>

</body>
</html>